<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QR –õ–æ–≥–≥–µ—Ä (GPS Control)</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5; margin: 0; padding: 0; color: #333;
            -webkit-tap-highlight-color: transparent;
        }
        header {
            background-color: #2b6cb0; color: white; padding: 15px; text-align: center;
            font-weight: 700; font-size: 18px; position: sticky; top: 0; z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center;
        }
        .status-indicator { font-size: 11px; background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 10px; }
        .container { padding: 15px; max-width: 600px; margin: 0 auto; padding-bottom: 80px; }

        /* –ö–Ω–æ–ø–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è */
        .scan-area {
            background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: center;
        }
        .btn-scan {
            width: 100%; padding: 20px; background: #2b6cb0; color: white;
            border: none; border-radius: 12px; font-size: 18px; font-weight: bold;
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .btn-scan:active { background: #2c5282; transform: scale(0.98); }
        
        /* –°–ø–∏—Å–æ–∫ –ª–æ–≥–æ–≤ */
        .log-card {
            background: white; border-radius: 8px; padding: 15px; margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center;
            border-left: 4px solid #cbd5e0;
        }
        .log-card.synced { border-left-color: #48bb78; }
        .log-card.unsynced { border-left-color: #ed8936; }

        .log-content { flex: 1; }
        .log-code { font-weight: bold; font-size: 16px; color: #2d3748; }
        .log-meta { font-size: 12px; color: #718096; margin-top: 4px; display: flex; flex-direction: column; gap: 2px; }
        .gps-tag { color: #dd6b20; font-weight: bold; }
        .gps-ok { color: #38a169; }

        .log-status { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: bold; margin-left: 10px; }
        .status-ok { background: #f0fff4; color: #2f855a; }
        .status-wait { background: #fffaf0; color: #dd6b20; }

        /* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ */
        .settings-box { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; }
        .input-text { width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 10px; box-sizing: border-box; }
        .btn-action { width: 100%; padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; margin-bottom: 5px; }
        .btn-sync { background: #48bb78; color: white; }
        .btn-clear { background: #fed7d7; color: #c53030; margin-top: 10px; }

        /* –ö–∞–º–µ—Ä–∞ */
        .camera-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: black; z-index: 500; display: none;
            flex-direction: column; justify-content: center;
        }
        .camera-overlay.active { display: flex; }
        #reader { width: 100%; }
        .close-cam {
            position: absolute; top: 20px; right: 20px;
            background: rgba(255,255,255,0.3); color: white;
            border: none; padding: 10px 20px; border-radius: 20px; font-weight: bold; z-index: 501;
        }

        .toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: #2d3748; color: white; padding: 10px 20px; border-radius: 20px;
            opacity: 0; transition: opacity 0.3s; z-index: 600; font-size: 14px; text-align: center;
        }
    </style>
</head>
<body>

    <header>
        <div>QR –õ–æ–≥–≥–µ—Ä <span style="font-size:12px; opacity:0.8">GPS</span></div>
        <div class="status-indicator" id="dbStatus">–û—á–µ—Ä–µ–¥—å: 0</div>
    </header>

    <div class="container">
        
        <div class="scan-area">
            <button class="btn-scan" onclick="startScanner()">üì∏ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR</button>
            <p style="font-size: 12px; color: #718096; margin-top: 10px;">
                –í–∫–ª—é—á–∏—Ç–µ GPS –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –º–µ—Å—Ç–∞.
            </p>
        </div>

        <div class="settings-box">
            <h3 style="margin-top:0; font-size:16px;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
            <input type="text" id="googleAppUrl" class="input-text" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ Google Script">
            <input type="text" id="deviceName" class="input-text" placeholder="–ò–º—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ / –û–±—ä–µ–∫—Ç">
            
            <button class="btn-action btn-sync" onclick="syncData()">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Google</button>
            <button class="btn-action btn-clear" onclick="clearLogs()">üóë –û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>

        <h3 style="margin-left: 5px; font-size: 16px;">–ò—Å—Ç–æ—Ä–∏—è</h3>
        <div id="logsList"></div>
    </div>

    <div class="camera-overlay" id="cameraModal">
        <button class="close-cam" onclick="stopScanner()">–ó–∞–∫—Ä—ã—Ç—å</button>
        <div id="reader"></div>
        <div style="color:white; text-align:center; margin-top:20px;">–ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ QR –∫–æ–¥</div>
    </div>

    <div id="toast" class="toast">–°–æ–æ–±—â–µ–Ω–∏–µ</div>

    <script>
        let logs = [];
        let html5QrCode;
        let isScanning = false;

        window.onload = function() {
            loadFromStorage();
            renderLogs();
        };

        function loadFromStorage() {
            const savedLogs = localStorage.getItem('qr_logs_gps');
            const savedUrl = localStorage.getItem('qr_google_url');
            const savedName = localStorage.getItem('qr_device_name');
            
            if (savedLogs) logs = JSON.parse(savedLogs);
            if (savedUrl) document.getElementById('googleAppUrl').value = savedUrl;
            if (savedName) document.getElementById('deviceName').value = savedName;
            updateStatus();
        }

        function saveToStorage() {
            localStorage.setItem('qr_logs_gps', JSON.stringify(logs));
            localStorage.setItem('qr_google_url', document.getElementById('googleAppUrl').value);
            localStorage.setItem('qr_device_name', document.getElementById('deviceName').value);
            updateStatus();
        }

        function updateStatus() {
            const unsynced = logs.filter(l => !l.synced).length;
            document.getElementById('dbStatus').innerText = `–û—á–µ—Ä–µ–¥—å: ${unsynced}`;
        }

        // --- –°–ö–ê–ù–ï–† + GPS ---
        function startScanner() {
            if (typeof Html5Qrcode === "undefined") {
                alert("–û—à–∏–±–∫–∞: –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Å–∫–∞–Ω–µ—Ä–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.");
                return;
            }
            document.getElementById('cameraModal').classList.add('active');
            html5QrCode = new Html5Qrcode("reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, (err) => {})
            .catch(err => { alert("–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã: " + err); stopScanner(); });
            isScanning = true;
        }

        function stopScanner() {
            if (isScanning && html5QrCode) {
                html5QrCode.stop().then(() => {
                    html5QrCode.clear();
                    document.getElementById('cameraModal').classList.remove('active');
                });
                isScanning = false;
            } else {
                document.getElementById('cameraModal').classList.remove('active');
            }
        }

        function onScanSuccess(decodedText, decodedResult) {
            stopScanner();
            showToast("–ö–æ–¥ –ø—Ä–∏–Ω—è—Ç! –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã...");
            
            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º GPS
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        addLog(decodedText, position.coords.latitude, position.coords.longitude);
                        showToast("‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ —Å GPS!");
                    },
                    function(error) {
                        // –ï—Å–ª–∏ GPS –≤—ã–∫–ª—é—á–µ–Ω –∏–ª–∏ –∑–∞–ø—Ä–µ—â–µ–Ω
                        addLog(decodedText, "–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞", "–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞");
                        alert("‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ! GPS –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω. –í–∫–ª—é—á–∏—Ç–µ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.");
                    },
                    { enableHighAccuracy: true, timeout: 10000 }
                );
            } else {
                addLog(decodedText, "–ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è", "–ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è");
            }
        }

        // --- –õ–û–ì–ò–ö–ê –î–ê–ù–ù–´–• ---
        function addLog(text, lat, lon) {
            const newLog = {
                id: Date.now(),
                code: text,
                ts: new Date().toISOString(),
                gps: { lat: lat, lon: lon },
                synced: false
            };
            logs.unshift(newLog);
            saveToStorage();
            renderLogs();
        }

        function renderLogs() {
            const container = document.getElementById('logsList');
            container.innerHTML = '';
            if (logs.length === 0) {
                container.innerHTML = '<div style="text-align:center; color:#a0aec0; padding:20px;">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</div>';
                return;
            }
            logs.forEach(log => {
                const date = new Date(log.ts);
                const timeStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                const hasGps = (log.gps && log.gps.lat !== "–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞" && log.gps.lat !== "–ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è");
                
                const el = document.createElement('div');
                el.className = `log-card ${log.synced ? 'synced' : 'unsynced'}`;
                el.innerHTML = `
                    <div class="log-content">
                        <div class="log-code">${log.code}</div>
                        <div class="log-meta">
                            <span>üïí ${timeStr}</span>
                            <span class="${hasGps ? 'gps-ok' : 'gps-tag'}">
                                üìç ${hasGps ? '–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã OK' : 'GPS –Ω–µ –Ω–∞–π–¥–µ–Ω'}
                            </span>
                        </div>
                    </div>
                    <div class="log-status ${log.synced ? 'status-ok' : 'status-wait'}">
                        ${log.synced ? 'OK' : 'WAIT'}
                    </div>`;
                container.appendChild(el);
            });
        }

        function clearLogs() {
            if(confirm("–£–¥–∞–ª–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏?")) {
                logs = logs.filter(l => !l.synced);
                saveToStorage(); renderLogs();
            }
        }

        // --- –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø ---
        async function syncData() {
            const url = document.getElementById('googleAppUrl').value;
            const deviceName = document.getElementById('deviceName').value || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π";
            if (!url) return alert("‚ùå –í–≤–µ–¥–∏—Ç–µ URL —Å–∫—Ä–∏–ø—Ç–∞!");
            
            const toSync = logs.filter(l => !l.synced);
            if (toSync.length === 0) return alert("–ù–µ—Ç –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö.");

            saveToStorage();
            const btn = document.querySelector('.btn-sync');
            const oldText = btn.innerText;
            btn.innerText = "‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...";
            btn.style.opacity = "0.7";

            try {
                await fetch(url, {
                    method: 'POST', mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ deviceName, data: toSync })
                });
                logs.forEach(l => { if (!l.synced) l.synced = true; });
                saveToStorage(); renderLogs();
                alert(`‚úÖ –£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${toSync.length}`);
            } catch (e) {
                alert("‚ùå –û—à–∏–±–∫–∞: " + e.message);
            } finally {
                btn.innerText = oldText; btn.style.opacity = "1";
            }
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.style.opacity = 1;
            setTimeout(() => t.style.opacity = 0, 3000);
        }
    </script>
</body>
</html>
