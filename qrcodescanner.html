<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QR –õ–æ–≥–≥–µ—Ä (Offline)</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        /* --- –°–¢–ò–õ–ò (–ù–∞ –±–∞–∑–µ —Ç–≤–æ–µ–≥–æ –¥–∏–∑–∞–π–Ω–∞) --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5; margin: 0; padding: 0; color: #333;
            -webkit-tap-highlight-color: transparent;
        }
        header {
            background-color: #2b6cb0; color: white; padding: 15px; text-align: center;
            font-weight: 700; font-size: 18px; position: sticky; top: 0; z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center;
        }
        .status-indicator { font-size: 11px; background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 10px; }
        
        .container { padding: 15px; max-width: 600px; margin: 0 auto; padding-bottom: 80px; }

        /* –ö–Ω–æ–ø–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è */
        .scan-area {
            background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: center;
        }
        .btn-scan {
            width: 100%; padding: 20px; background: #2b6cb0; color: white;
            border: none; border-radius: 12px; font-size: 18px; font-weight: bold;
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .btn-scan:active { background: #2c5282; transform: scale(0.98); }
        
        /* –°–ø–∏—Å–æ–∫ —Å–∫–∞–Ω–æ–≤ */
        .log-card {
            background: white; border-radius: 8px; padding: 15px; margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center;
            border-left: 4px solid #cbd5e0;
        }
        .log-card.synced { border-left-color: #48bb78; } /* –ó–µ–ª–µ–Ω—ã–π - –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ */
        .log-card.unsynced { border-left-color: #ed8936; } /* –û—Ä–∞–Ω–∂–µ–≤—ã–π - –∂–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ */

        .log-content { flex: 1; }
        .log-code { font-weight: bold; font-size: 16px; color: #2d3748; word-break: break-all; }
        .log-time { font-size: 12px; color: #718096; margin-top: 4px; }
        .log-status { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: bold; margin-left: 10px; }
        
        .status-ok { background: #f0fff4; color: #2f855a; }
        .status-wait { background: #fffaf0; color: #dd6b20; }

        /* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ / –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è */
        .settings-box { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; }
        .input-text { width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 10px; box-sizing: border-box; }
        .btn-action { width: 100%; padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; margin-bottom: 5px; }
        .btn-sync { background: #48bb78; color: white; }
        .btn-clear { background: #fed7d7; color: #c53030; margin-top: 10px; }

        /* –ö–∞–º–µ—Ä–∞ (–º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ) */
        .camera-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: black; z-index: 500; display: none;
            flex-direction: column; justify-content: center;
        }
        .camera-overlay.active { display: flex; }
        #reader { width: 100%; }
        .close-cam {
            position: absolute; top: 20px; right: 20px;
            background: rgba(255,255,255,0.3); color: white;
            border: none; padding: 10px 20px; border-radius: 20px; font-weight: bold; z-index: 501;
        }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ */
        .toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: #2d3748; color: white; padding: 10px 20px; border-radius: 20px;
            opacity: 0; transition: opacity 0.3s; z-index: 600; font-size: 14px;
        }
    </style>
</head>
<body>

    <header>
        <div>QR –õ–æ–≥–≥–µ—Ä</div>
        <div class="status-indicator" id="dbStatus">–ó–∞–ø–∏—Å–µ–π: 0</div>
    </header>

    <div class="container">
        
        <div class="scan-area">
            <button class="btn-scan" onclick="startScanner()">
                üì∏ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR
            </button>
            <p style="font-size: 12px; color: #718096; margin-top: 10px;">
                –ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –∫–∞–º–µ—Ä—É. –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ.
            </p>
        </div>

        <div class="settings-box">
            <h3 style="margin-top:0; font-size:16px;">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</h3>
            <input type="text" id="googleAppUrl" class="input-text" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ Google Script">
            <input type="text" id="deviceName" class="input-text" placeholder="–ò–º—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ / –¢–æ—á–∫–∏">
            
            <button class="btn-action btn-sync" onclick="syncData()">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Google</button>
            <button class="btn-action btn-clear" onclick="clearLogs()">üóë –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
        </div>

        <h3 style="margin-left: 5px; font-size: 16px;">–ò—Å—Ç–æ—Ä–∏—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π</h3>
        <div id="logsList"></div>

    </div>

    <div class="camera-overlay" id="cameraModal">
        <button class="close-cam" onclick="stopScanner()">–ó–∞–∫—Ä—ã—Ç—å</button>
        <div id="reader"></div>
        <div style="color:white; text-align:center; margin-top:20px;">–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR –∫–æ–¥</div>
    </div>

    <div id="toast" class="toast">–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!</div>

    <script>
        // --- –î–ê–ù–ù–´–ï ---
        let logs = [];
        let html5QrCode;
        let isScanning = false;

        // --- INIT ---
        window.onload = function() {
            loadFromStorage();
            renderLogs();
        };

        // --- STORAGE ---
        function loadFromStorage() {
            const savedLogs = localStorage.getItem('qr_logs');
            const savedUrl = localStorage.getItem('qr_google_url');
            const savedName = localStorage.getItem('qr_device_name');
            
            if (savedLogs) logs = JSON.parse(savedLogs);
            if (savedUrl) document.getElementById('googleAppUrl').value = savedUrl;
            if (savedName) document.getElementById('deviceName').value = savedName;
            
            updateStatus();
        }

        function saveToStorage() {
            localStorage.setItem('qr_logs', JSON.stringify(logs));
            localStorage.setItem('qr_google_url', document.getElementById('googleAppUrl').value);
            localStorage.setItem('qr_device_name', document.getElementById('deviceName').value);
            updateStatus();
        }

        function updateStatus() {
            const unsynced = logs.filter(l => !l.synced).length;
            document.getElementById('dbStatus').innerText = `–ñ–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏: ${unsynced}`;
        }

        // --- SCANNER LOGIC ---
        function startScanner() {
            document.getElementById('cameraModal').classList.add('active');
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∫–∞–Ω–µ—Ä–∞
            html5QrCode = new Html5Qrcode("reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure)
            .catch(err => {
                alert("–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∫–∞–º–µ—Ä—ã: " + err);
                stopScanner();
            });
            isScanning = true;
        }

        function stopScanner() {
            if (isScanning && html5QrCode) {
                html5QrCode.stop().then(() => {
                    html5QrCode.clear();
                    document.getElementById('cameraModal').classList.remove('active');
                }).catch(err => console.log(err));
                isScanning = false;
            } else {
                document.getElementById('cameraModal').classList.remove('active');
            }
        }

        function onScanSuccess(decodedText, decodedResult) {
            // –ß—Ç–æ–±—ã –Ω–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–ª –æ–¥–∏–Ω –∫–æ–¥ 100 —Ä–∞–∑ –ø–æ–¥—Ä—è–¥, –¥–µ–ª–∞–µ–º –ø–∞—É–∑—É –∏–ª–∏ —Å—Ç–æ–ø–∞–µ–º
            stopScanner(); 
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            addLog(decodedText);
            
            // –ó–≤—É–∫ –∏–ª–∏ –≤–∏–±—Ä–∞—Ü–∏—è (–µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)
            if (navigator.vibrate) navigator.vibrate(200);
            showToast("QR –∫–æ–¥ —Å—á–∏—Ç–∞–Ω!");
        }

        function onScanFailure(error) {
            // console.warn(`Code scan error = ${error}`);
        }

        // --- LOGIC ---
        function addLog(text) {
            const newLog = {
                id: Date.now(),
                code: text,
                ts: new Date().toISOString(),
                synced: false
            };
            logs.unshift(newLog); // –î–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ
            saveToStorage();
            renderLogs();
        }

        function renderLogs() {
            const container = document.getElementById('logsList');
            container.innerHTML = '';
            
            if (logs.length === 0) {
                container.innerHTML = '<div style="text-align:center; color:#a0aec0; padding:20px;">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>';
                return;
            }

            logs.forEach(log => {
                const date = new Date(log.ts);
                const timeStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                
                const el = document.createElement('div');
                el.className = `log-card ${log.synced ? 'synced' : 'unsynced'}`;
                el.innerHTML = `
                    <div class="log-content">
                        <div class="log-code">${log.code}</div>
                        <div class="log-time">${timeStr}</div>
                    </div>
                    <div class="log-status ${log.synced ? 'status-ok' : 'status-wait'}">
                        ${log.synced ? 'OK' : 'WAIT'}
                    </div>
                `;
                container.appendChild(el);
            });
        }

        function clearLogs() {
            if(confirm("–£–¥–∞–ª–∏—Ç—å —Ç–æ–ª—å–∫–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏? (–û—Ç–º–µ–Ω–∞ - —É–¥–∞–ª–∏—Ç—å –í–°–ï)")) {
                logs = logs.filter(l => !l.synced); // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –Ω–µ–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ
            } else {
                logs = [];
            }
            saveToStorage();
            renderLogs();
        }

        // --- SYNC ---
        async function syncData() {
            const url = document.getElementById('googleAppUrl').value;
            const deviceName = document.getElementById('deviceName').value || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π";
            
            if (!url) return alert("‚ùå –í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ Google Script!");

            // –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ, —á—Ç–æ –µ—â–µ –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã
            const toSync = logs.filter(l => !l.synced);
            
            if (toSync.length === 0) return alert("–ù–µ—Ç –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏.");

            saveToStorage(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            
            const btn = document.querySelector('.btn-sync');
            const oldText = btn.innerText;
            btn.innerText = "‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...";
            btn.style.opacity = "0.7";

            const payload = {
                deviceName: deviceName,
                data: toSync
            };

            try {
                await fetch(url, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                // –í —Ä–µ–∂–∏–º–µ no-cors –º—ã –Ω–µ –∑–Ω–∞–µ–º —Ç–æ—á–Ω–æ –æ—Ç–≤–µ—Ç, –Ω–æ —Å—á–∏—Ç–∞–µ–º —É—Å–ø–µ—à–Ω—ã–º, –µ—Å–ª–∏ –Ω–µ—Ç –æ—à–∏–±–∫–∏ —Å–µ—Ç–∏
                // –ü–æ–º–µ—á–∞–µ–º –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –∫–∞–∫ synced
                logs.forEach(l => { if (!l.synced) l.synced = true; });
                saveToStorage();
                renderLogs();
                
                alert(`‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${toSync.length}`);
            } catch (e) {
                alert("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: " + e.message);
            } finally {
                btn.innerText = oldText;
                btn.style.opacity = "1";
            }
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.opacity = 1;
            setTimeout(() => t.style.opacity = 0, 2000);
        }
    </script>
</body>
</html>
